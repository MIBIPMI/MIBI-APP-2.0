import React,{useState} from 'react';import Tesseract from 'tesseract.js';import axios from 'axios';import { useTranslation } from 'react-i18next';import { Link } from 'react-router-dom';export default function Upload(){const { t } = useTranslation();const [file,setFile]=useState(null);const [status,setStatus]=useState('');const [parsed,setParsed]=useState({ref:'',nif:'',amount:''});const onFile=async(e)=>{const f=e.target.files[0];if(!f)return;setFile(f);setStatus('Running OCR...');try{const {data}=await Tesseract.recognize(f,'spa+deu+eng');const text=data.text;const ref=(text.match(/[A-Z0-9]{20}/i)||[])[0]||'';const nif=(text.match(/\b([0-9]{8}[A-Z]|[XYZ][0-9]{7}[A-Z])\b/i)||[])[0]||'';const amount=(text.match(/([0-9]{1,3}(?:[.,][0-9]{3})*(?:[.,][0-9]{2}))/)||[])[0]||'';setParsed({ref,nif,amount});setStatus('OCR done.');}catch(e){console.error(e);setStatus('OCR failed');}};const uploadToS3=async()=>{if(!file)return;setStatus('Requesting upload URL...');const res=await axios.post('/api/upload-url',{ filename:file.name, contentType:file.type });const { uploadUrl,key }=res.data;await fetch(uploadUrl,{method:'PUT',headers:{'Content-Type':file.type},body:file});setStatus('Uploaded. Key: '+key);};const pay=async(mode)=>{setStatus('Creating checkout...');const res=await axios.post('/api/create-checkout-session',{ mode });window.location=res.data.url;};return(<div className='min-h-screen bg-onyx text-white p-6 flex items-center justify-center'><div className='w-full max-w-3xl'><div className='mb-4'><Link to='/' className='text-gold'>&larr; {t('back')}</Link></div><h2 className='text-2xl font-semibold text-gold mb-4'>{t('upload_title')}</h2><input type='file' accept='image/*,application/pdf' capture='environment' onChange={onFile} className='mb-4'/>{status && <div className='text-sm text-gray-300 mb-4'>{status}</div>}<div className='grid md:grid-cols-3 gap-4'><div className='md:col-span-2 bg-gray-900 rounded-xl p-4'><div className='grid grid-cols-1 gap-2'><label>Referencia catastral</label><input defaultValue={parsed.ref} className='p-2 rounded bg-gray-800 border border-gray-700'/><label>NIF / NIE</label><input defaultValue={parsed.nif} className='p-2 rounded bg-gray-800 border border-gray-700'/><label>Importe (â‚¬)</label><input defaultValue={parsed.amount} className='p-2 rounded bg-gray-800 border border-gray-700'/></div></div><div className='bg-gray-900 rounded-xl p-4 space-y-2'><button onClick={uploadToS3} className='w-full bg-gold text-black py-2 rounded font-semibold'>Upload</button><button onClick={()=>pay('payment')} className='w-full bg-blue-600 text-white py-2 rounded'>{t('pay_once')}</button><button onClick={()=>pay('subscription')} className='w-full bg-green-600 text-white py-2 rounded'>{t('subscribe')}</button></div></div></div></div>);}